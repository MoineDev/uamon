---
import Layout from "../../layouts/Layout.astro";
import servers from "../../data/servers.json";

export function getStaticPaths() {
  return servers.map((s) => ({
    params: { slug: s.slug },
  }));
}

const { slug } = Astro.params;
const server = servers.find((s) => s.slug === slug);

if (!server) {
  return new Response("Server not found", { status: 404 });
}
---

<Layout title={`${server.name} — UAMON`}>
  <!-- Передаємо API сюди  -->
  <main class="mx-auto max-w-3xl px-4 py-8" data-api={server.api}>
    <a href="/monitoring/java" class="text-sm text-white/70 hover:text-white underline">
      <i class="fa-solid fa-arrow-left mr-2"></i>Назад
    </a>

    <div class="mt-4 rounded-2xl bg-neutral-800/60 border border-white/10 p-6">
      <div class="flex items-start gap-4">
        <img
          src={server.icon ? server.icon : "/icons/default.png"}
          alt={server.name}
          class="w-20 h-20 rounded-2xl object-cover bg-white/10 shrink-0"
          loading="lazy"
          onerror="this.onerror=null; this.src='/icons/default.png';"
        />

        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-2">
            <h1 class="text-2xl font-extrabold text-white truncate">{server.name}</h1>
            <!-- Крапка: спочатку сіра, потім стане зелена/червона -->
            <span class="status-dot w-3 h-3 rounded-full bg-gray-500 shrink-0"></span>
          </div>

          <p class="text-sm font-bold text-white/80 uppercase mt-1">{server.tags1}</p>
          <p class="text-sm font-bold text-white/60 uppercase">{server.tags2}</p>

          <div class="mt-3 flex flex-wrap items-center gap-3">
            <p class="text-sm text-white/90 truncate flex items-center gap-2">
              <i class="fa-solid fa-server text-white/60"></i>
              <span>IP:</span>
            </p>

            <p class="text-sm text-white/90 truncate flex items-center gap-2">
              
              <span>{server.ip}</span>
            </p>

            <button
              type="button"
              class="copy-ip px-3 py-1.5 rounded-lg text-xs font-semibold
                     bg-neutral-700/70 border border-white/10
                     text-white/90 hover:bg-neutral-700 hover:text-white
                     active:scale-[0.97] transition flex items-center gap-2"
              data-ip={server.ip}
            >
              <i class="fa-solid fa-copy"></i>
              Скопіювати IP
            </button>

            <span class="text-sm text-white/80 flex items-center gap-2">
              <i class="fa-solid fa-users text-white/60"></i>
              Онлайн: <span class="js-online">…</span>
            </span>
          </div>
        </div>
      </div>

      {server.description && (
        <div class="mt-6">
          <h2 class="text-lg font-extrabold text-white flex items-center gap-2">
            <i class="fa-solid fa-align-left text-white/60"></i>
            Опис
          </h2>

          <p class="mt-2 text-white/80 leading-relaxed whitespace-pre-line">
            {server.description}
          </p>

          {/*  БЛОК ПОСИЛАНЬ */}
          {(
            server.website ||
            server.discord ||
            server.telegram ||
            server.youtube ||
            server.tiktok ||
            server.map
          ) && (
            <div class="mt-6 rounded-xl border border-white/15 bg-neutral-900/60 backdrop-blur">
              <div class="border-b border-white/10 px-4 py-2 text-sm font-semibold text-white/70 flex items-center gap-2">
                <i class="fa-solid fa-link text-white/60"></i>
                Посилання
              </div>

              <div class="flex flex-col gap-1 p-3 text-sm">
                {server.website && (
                  <a href={server.website} target="_blank"
                    class="flex items-center gap-3 rounded-lg px-3 py-2 text-white/80 hover:bg-white/5 hover:text-white transition">
                    <i class="fa-solid fa-globe text-white/70"></i>
                    <span>Вебсайт</span>
                  </a>
                )}

                {server.map && (
                  <a href={server.map} target="_blank"
                    class="flex items-center gap-3 rounded-lg px-3 py-2 text-white/80 hover:bg-white/5 hover:text-white transition">
                    <i class="fa-solid fa-map-location-dot text-white/70"></i>
                    <span>Мапа</span>
                  </a>
                )}

                {server.discord && (
                  <a href={server.discord} target="_blank"
                    class="flex items-center gap-3 rounded-lg px-3 py-2 text-white/80 hover:bg-white/5 hover:text-white transition">
                    <i class="fa-brands fa-discord text-white/70"></i>
                    <span>Discord</span>
                  </a>
                )}

                {server.telegram && (
                  <a href={server.telegram} target="_blank"
                    class="flex items-center gap-3 rounded-lg px-3 py-2 text-white/80 hover:bg-white/5 hover:text-white transition">
                    <i class="fa-brands fa-telegram text-white/70"></i>
                    <span>Telegram</span>
                  </a>
                )}

                {server.youtube && (
                  <a href={server.youtube} target="_blank"
                    class="flex items-center gap-3 rounded-lg px-3 py-2 text-white/80 hover:bg-white/5 hover:text-white transition">
                    <i class="fa-brands fa-youtube text-white/70"></i>
                    <span>YouTube</span>
                  </a>
                )}

                {server.tiktok && (
                  <a href={server.tiktok} target="_blank"
                    class="flex items-center gap-3 rounded-lg px-3 py-2 text-white/80 hover:bg-white/5 hover:text-white transition">
                    <i class="fa-brands fa-tiktok text-white/70"></i>
                    <span>TikTok</span>
                  </a>
                )}
              </div>
            </div>
          )}
        </div>
      )}
    </div>

    <!-- ОДИН скрипт: копіювання + онлайн + крапка -->
    <script is:inline>
      (function () {
        const root = document.querySelector("main[data-api]");
        if (!root) return;

        // 1) Copy IP
        const copyBtn = root.querySelector(".copy-ip");
        if (copyBtn) {
          copyBtn.addEventListener("click", async () => {
            const ip = copyBtn.dataset.ip || "";
            try {
              await navigator.clipboard.writeText(ip);
              const oldText = copyBtn.textContent;
              copyBtn.innerHTML = '<i class="fa-solid fa-check"></i>Скопійовано!';
              copyBtn.classList.add("text-green-400");
              setTimeout(() => {
                copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i>Скопіювати IP';
                copyBtn.classList.remove("text-green-400");
              }, 1500);
            } catch (e) {
              alert("Не вдалося скопіювати. Спробуй вручну: " + ip);
            }
          });
        }

        // 2) Online + dot
        async function loadOnline() {
          const api = root.dataset.api;
          const onlineEl = root.querySelector(".js-online");
          const dotEl = root.querySelector(".status-dot");

          if (!api || !onlineEl || !dotEl) return;

          try {
            const res = await fetch(api, { cache: "no-store" });
            const data = await res.json();

            const isUp = data?.online === true;
            const online = data?.players?.online ?? 0;
            const max = data?.players?.max ?? 0;

            onlineEl.textContent = isUp ? `${online}/${max}` : "офлайн";

            dotEl.classList.remove("bg-gray-500", "bg-green-500", "bg-red-500");
            dotEl.classList.add(isUp ? "bg-green-500" : "bg-red-500");
          } catch (e) {
            onlineEl.textContent = "—";
            dotEl.classList.remove("bg-green-500", "bg-red-500");
            dotEl.classList.add("bg-gray-500");
          }
        }

        loadOnline();
      })();
    </script>
  </main>
</Layout>
