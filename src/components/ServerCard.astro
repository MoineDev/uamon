---
const { server } = Astro.props;
---

<a
  href={`/server/${server.slug}`}
  data-server-card
  data-api={server.api}
  class="block rounded-2xl bg-neutral-800/60 border border-white/10
         p-4 flex gap-4 items-start
         hover:bg-neutral-800/80 transition cursor-pointer"
>
  <!-- Icon -->
  <img
    src={server.icon || "/icons/default.png"}
    alt={server.name}
    class="w-16 h-16 rounded-xl object-cover bg-white/10 shrink-0"
    loading="lazy"
    onerror="this.onerror=null; this.src='/icons/default.png';"
  />

  <!-- Content -->
  <div class="flex-1 min-w-0">
    <div class="flex items-center gap-2">
      <h3 class="text-white font-extrabold text-xl leading-none truncate">
        {server.name}
      </h3>

      <span class="status-dot w-3 h-3 rounded-full bg-gray-500 shrink-0"></span>
    </div>

    <p class="text-sm font-bold text-white/80 uppercase truncate mt-1">
      {server.tags1}
    </p>
    <p class="text-sm font-bold text-white/60 uppercase truncate">
      {server.tags2}
    </p>

    <div class="mt-2 flex items-center justify-between gap-3">
      <p class="text-sm text-white/90 truncate">{server.ip}</p>

      <!-- Copy button -->
      <button
        type="button"
        class="copy-ip px-3 py-1.5 rounded-lg text-xs font-semibold
               bg-neutral-700/70 border border-white/10
               text-white/90 hover:bg-neutral-700 hover:text-white
               active:scale-[0.97] transition"
        data-ip={server.ip}
      >
        Скопіювати IP
      </button>

      <p class="text-sm text-white/80 whitespace-nowrap">
        Онлайн: <span class="js-online">…</span>
      </p>
    </div>
  </div>

  <script is:inline>
    (function () {
      const cards = document.querySelectorAll("[data-server-card]");

      async function loadOnline(card) {
        const api = card.dataset.api;
        const onlineEl = card.querySelector(".js-online");
        const dot = card.querySelector(".status-dot");

        try {
          const res = await fetch(api, { cache: "no-store" });
          const data = await res.json();

          const isUp = data?.online === true;
          const online = data?.players?.online ?? 0;
          const max = data?.players?.max ?? 0;

          onlineEl.textContent = isUp ? `${online}/${max}` : "офлайн";

          dot.classList.remove("bg-gray-500", "bg-green-500", "bg-red-500");
          dot.classList.add(isUp ? "bg-green-500" : "bg-red-500");

          card.classList.toggle("opacity-60", !isUp);
        } catch {
          onlineEl.textContent = "офлайн";
          dot.classList.remove("bg-green-500");
          dot.classList.add("bg-red-500");
          card.classList.add("opacity-60");
        }
      }

      cards.forEach((card) => {
        loadOnline(card);
        setInterval(() => loadOnline(card), 30000);

        const btn = card.querySelector(".copy-ip");
        if (btn) {
          btn.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const ip = btn.dataset.ip;
            await navigator.clipboard.writeText(ip);

            const old = btn.textContent;
            btn.textContent = "Скопійовано!";
            btn.classList.add("text-green-300");

            setTimeout(() => {
              btn.textContent = old;
              btn.classList.remove("text-green-300");
            }, 1200);
          });
        }
      });
    })();
  </script>
</a>